<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pesquisa Copilot - Prompt Pré‑preenchido</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:900px;margin:28px auto;padding:18px;color:#111}
    h1{font-size:20px;margin-bottom:6px}
    p{margin:8px 0 16px}
    textarea{width:100%;height:260px;padding:12px;font-size:14px;box-sizing:border-box}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{background:#0067C5;color:#fff;padding:10px 14px;border-radius:8px;text-decoration:none;border:none;cursor:pointer}
    .btn.secondary{background:#666}
    .note{font-size:13px;color:#444;margin-top:12px}
    .success{color:green}
    .error{color:#b00020}
  </style>
</head>
<body>
  <h1>Pesquisa Copilot — Prompt Pré‑preenchido</h1>
  <p id="intro">A página monta automaticamente o prompt a partir do parâmetro <strong>q</strong> na URL. Ex.: <code>?q=Acme%20Industria%20S.A.</code></p>

  <label for="prompt">Prompt gerado</label>
  <textarea id="prompt" readonly></textarea>

  <div class="row">
    <button id="openCopilot" class="btn">Abrir no Copilot</button>
    <button id="sharePrompt" class="btn secondary">Compartilhar prompt</button>
    <button id="copyPrompt" class="btn secondary">Copiar prompt</button>
    <button id="openCopilotManual" class="btn secondary">Abrir instruções</button>
  </div>

  <p class="note" id="status"></p>

  <script>
    // Template do prompt (edite se quiser)
    const promptTemplate = `Por favor pesquisar sobre a Empresa {NOME_DA_EMPRESA} e trazer as informações, conforme os tópicos abaixo, de forma objetiva e clara. Após os destaques dos tópicos, gerar no final um resumo e destacar as oportunidades para automação e/ou inovação, os pontos de atenção, riscos e outras informações que achar relevante. Gerar também um arquivo Word mantendo o formato e estrutura e colocando o título no arquivo com o nome da Empresa pesquisada.

1. Qual ramo ou atividade da Empresa?
2. Qual produto ou serviço principal?
3. Qual a volumetria da operação mensal?
4. Qual faturamento mensal e anual?
5. Qual ERP ou sistema utiliza para executar suas operações?
6. Quais os processos, operações ou áreas existentes na Empresa?`;

    // Ajuste: se souber o package do app no Android, coloque aqui (opcional, para tentar intent)
    const ANDROID_INTENT_PACKAGE = ''; // ex: 'com.microsoft.copilot' (preencha se souber)

    function getQueryParam(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || '';
    }

    function buildPrompt(companyName){
      const safeName = companyName.trim() || '{NOME_DA_EMPRESA}';
      return promptTemplate.replace('{NOME_DA_EMPRESA}', safeName);
    }

    const company = getQueryParam('q') || '';
    const promptArea = document.getElementById('prompt');
    const status = document.getElementById('status');
    let promptText = buildPrompt(company);
    promptArea.value = promptText;

    // --- Funções auxiliares de deep link ---
    // Lista de esquemas a tentar (você pode editar/estender)
    const schemes = [
      'copilot://compose?prompt=',
      'microsoft-copilot://compose?prompt=',
      'ms-copilot://compose?prompt=',
      'copilot-ai://compose?prompt='
    ];

    async function tryOpenDeepLinkSequential(prompt) {
      // Tenta vários esquemas em sequência até um ter efeito (ou testar todos)
      for (let scheme of schemes) {
        const url = scheme + encodeURIComponent(prompt);
        const opened = await tryOpenUrl(url);
        if (opened) return true;
      }

      // Opcional: tentar Intent do Android se foi fornecido package
      if (ANDROID_INTENT_PACKAGE && /Android/i.test(navigator.userAgent)) {
        const intentUrl = 'intent://compose?prompt=' + encodeURIComponent(prompt) +
                          '#Intent;scheme=copilot;package=' + ANDROID_INTENT_PACKAGE + ';end';
        const openedIntent = await tryOpenUrl(intentUrl);
        if (openedIntent) return true;
      }

      return false;
    }

    function tryOpenUrl(url) {
      return new Promise((resolve) => {
        // Estratégia: abre o URL e observa se a página fica oculta (visibilitychange)
        let resolved = false;
        const onVisibility = () => {
          if (document.hidden) {
            resolved = true;
            cleanup();
            resolve(true); // provavelmente o app abriu
          }
        };
        document.addEventListener('visibilitychange', onVisibility);

        // tentativa: abrir via window.location (menos restrito que iframe em alguns navegadores)
        const newWindow = window.open(url, '_self');

        // fallback timeout: se em 1200ms nada, consideramos que não abriu
        const timeout = setTimeout(() => {
          if (!resolved) {
            cleanup();
            resolve(false);
          }
        }, 1200);

        function cleanup() {
          clearTimeout(timeout);
          document.removeEventListener('visibilitychange', onVisibility);
        }
      });
    }

    // Event: Abrir no Copilot
    document.getElementById('openCopilot').addEventListener('click', async () => {
      status.textContent = 'Tentando abrir o Copilot...';
      status.className = 'note';
      const success = await tryOpenDeepLinkSequential(promptArea.value);
      if (success) {
        status.textContent = 'Se o app Copilot estiver instalado, ele deve ter sido aberto.';
        status.className = 'note success';
      } else {
        status.textContent = 'Não foi possível abrir automaticamente. Use "Compartilhar prompt" ou "Copiar prompt".';
        status.className = 'note';
      }
    });

    // Web Share API: abre a folha de compartilhamento do sistema (muito útil em celulares)
    document.getElementById('sharePrompt').addEventListener('click', async () => {
      const textToShare = promptArea.value;
      if (navigator.share) {
        try {
          await navigator.share({ title: 'Prompt Copilot', text: textToShare });
          status.textContent = 'Folha de compartilhamento aberta. Escolha o app Copilot (se disponível).';
          status.className = 'note success';
        } catch (e) {
          status.textContent = 'Compartilhamento cancelado ou falhou.';
          status.className = 'note error';
        }
      } else {
        status.textContent = 'Compartilhamento não suportado no seu navegador. Use "Copiar prompt".';
        status.className = 'note';
      }
    });

    // Copiar para clipboard
    document.getElementById('copyPrompt').addEventListener('click', async () => {
      try {
        promptText = promptArea.value;
        await navigator.clipboard.writeText(promptText);
        status.textContent = 'Prompt copiado para a área de transferência.';
        status.className = 'note success';
      } catch (e) {
        status.textContent = 'Não foi possível copiar automaticamente. Selecione o texto e copie manualmente.';
        status.className = 'note error';
      }
    });

    // Instruções simples
    document.getElementById('openCopilotManual').addEventListener('click', () => {
      alert('Se o Copilot não abrir automaticamente:\n\n1) Clique em "Compartilhar prompt" e escolha Copilot na lista (ou)\n2) Clique em "Copiar prompt", abra o app Copilot e cole o prompt no campo de entrada.\n\nObservação: deep links dependem do app registrar o esquema (copilot://) e do navegador permitir a abertura.');
    });

    if (!company) {
      status.textContent = 'Nenhum nome de empresa informado na URL. Use ?q=Nome%20da%20Empresa';
      status.className = 'note';
    } else {
      status.textContent = 'Prompt pronto. Você pode tentar abrir o Copilot, compartilhar ou copiar.';
      status.className = 'note';
    }
  </script>
</body>
</html>
